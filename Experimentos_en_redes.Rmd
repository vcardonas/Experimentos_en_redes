---
title: "Experimentos en Redes"
author: 
- Valentina Cardona & Natalia Perdomo
- Email vcardonas@unal.edu.co & naperdomol@unal.edu.co
- GitHub https://github.com/vcardonas
- Rpubs https://rpubs.com/vcardonas
date: ""
output:
  html_document:
    highlight: default
    theme: cosmo #yeti #united #flatly #spacelab
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(kableExtra)
```

# Introducción

En todas las ciencias existe un interés generalizado en evaluar el efecto de tratamientos o intervenciones de diversos tipos. Podría decirse que el ejemplo prototípico de este tipo de estudios es el **ensayo aleatorio** (en inglés, *randomized controlled trial*, RTC), también llamado como
$$Prueba\ A/B$$
Este diseño experimental convencional se caracteriza por dos aspectos principales:

1.  La noción de **dos grupos a comparar** (tratamiento y control, o A y B).

2.  La **asignación aleatoria** de individuos a dichos grupos.

Sin embargo, en estos experimentos suele asumirse que el tratamiento dado a un individuo no influye en los resultados de otros individuos (**no interferencia**).

Naturalmente, **al realizar experimentos en redes no se puede descartar de manera realista la interferencia**.

# Inferencia Causal

El experimento para **evaluar la eficacia de un tratamiento** en una población finita, considerando las relaciones entre pares de individuos que esperamos sean relevantes, se representa como:
$$G=(V,E)$$
donde los vértices en $V$ corresponden a $N_V$ individuos de la población y las aristas en $E$ a sus relaciones.

Definimos:

- $z_i = 1$ si el individuo $i \in V$ **recibe el tratamiento** y $z_i = 0$ si no.

- $\mathbf{z} = (z_1, \ldots, z_{N_v})^T \in \{0, 1\}^{N_v}$ como el **vector de asignación de tratamientos**.

-  $p_{\mathbf{z}} = \mathbb{P}(\mathbf{Z} = \mathbf{z})$ como la probabilidad de que una asignación de tratamientos \( \mathbf{z} \) sea generada por el diseño experimental.

- $\mathscr{O}_i(\mathbf{z})$ como el resultado para el individuo $i$ bajo el tratamiento $\mathbf{z}$.

Aunque deseamos evaluar la diferencia en los resultados de los individuos bajo diferentes tratamientos, **no podemos medir múltiples resultados simúltaneamente en un mismo individuo**.

## Marco de Resultados Potenciales

En el modelo causal de Rubin, se consideran tanto los resultados observados como los contrafactuales (potenciales). Además, se asume que **no hay interferencia entre individuos**, conocido como el **supuesto del valor de tratamiento unitario estable** (en inglés, *stable unit treatment value assumption*, SUTVA):
$$\mathscr{O}_i(\mathbf{z})=\mathscr{O}_i(z_i)$$
En este *mundo ideal*, el **efecto promedio del tratamiento** (en inglés, *average treatment effect*, ATE) se estimaría de tal forma que
$$
\tau_{ATE} = \frac{1}{N_v} \sum_{i=1}^{N_v} \left[ \mathscr{O}_i(1) - \mathscr{O}_i(0) \right] = \bar{\mathscr{O}}(1) - \bar{\mathscr{O}}(0)
$$ 

## Estimadores

Al considerar un experimento aleatorio, donde $N_t$ individuos reciben tratamiento y $N_c=N_v-N_t$ son control, la probabilidad de asignación de tratamiento es $p_z = \left( \frac{N_v}{N_t} \right)^{-1}$.

El estimador insesgado de $\tau_{ATE}$ es
$$\hat{\tau}_{ATE}(\mathbf{z}) = \frac{1}{N_v} \sum_{i=1}^{N_v} \left[ \frac{z_i\mathscr{O}_i(1)}{N_t / N_v} - \frac{(1 - z_i) \mathscr{O}_i(0)}{N_c / N_v} \right]$$
La varianza de este estimador está dada por
$$Var(\hat{\tau}_{ATE}(\mathbf{Z})) = \frac{S_c^2}{N_c} + \frac{S_t^2}{N_t} + \frac{S_tc^2}{N_v}$$
donde 
$$S_c^2 = \frac{1}{N_v - 1} \sum_{i=1}^{N_v} \left[ \mathscr{O}_i(1) - \bar{\mathscr{O}}(0) \right]^2 \quad \text{,}$$
$$S_t^2 = \frac{1}{N_v - 1} \sum_{i=1}^{N_v} \left[ \mathscr{O}_i(1) - \bar{\mathscr{O}}(1) \right]^2 \quad \text{y}$$
$$S_{tc}^2 = \frac{1}{N_v - 1} \sum_{i=1}^{N_v} \left[ \mathscr{O}_i(1) - \mathscr{O}_i(0) - \tau_{ATE}\right]^2 $$
En la práctica, es común utilizar este estimador bajo el supuesto de un efecto de tratamiento constante (con *varianza de los efectos del tratamiento* $S_{tc}^2 = 0$) o derivar estimadores basados en otros supuestos.

Lastimosamente, **no podemos estimar dicha varianza basándose únicamente en los resultados observados**, ya que no observamos ambos $\mathscr{O}_i(1)$ y $\mathscr{O}_i(0)$ para cualquiera de los individuos.

# Inferencia de Red

En el contexto de las redes, se puede esperar que haya **interferencia**, es decir,
$$\mathscr{O}_i(\mathbf{Z}) \neq \mathscr{O}_i(Z_i)$$

## Ejemplo

Una nueva dirección en una planta de productos forestales propuso cambios en el paquete de compensación de los trabajadores. Inicialmente, dos negociadores sindicales explicaron los cambios a los demás, pero los trabajadores no los aceptaron, resultando en una huelga. La dirección solicitó a un consultor externo que analizara la estructura de comunicación entre 24 trabajadores relevantes. Al identificar la red social, se explicó los cambios a dos trabajadores específicos, quienes discutieron con sus colegas. En dos días, los trabajadores pidieron reabrir las negociaciones y la huelga se resolvió. La red final tenía 24 vértices y 38 aristas.

```{r, fig.align='center'}
# Librerías
library(igraph)
library(sand)

# Cargar datos
data(strike)
summary(strike)
```

Una arista entre dos vértiuces indica que los empleados se comunicaron con un nivel de frencuencia mínimamente suficiente sobre la huelga. Hay tres subgrupos presentes en la red, codificados por el atributo nodal $\verb|race|$.

```{r, fig.align='center'}
# O -> Older
# Y -> Younger
# ---------------------
# E -> English-speaking
# S -> Spanish-speaking
table(V(strike)$race)
```

La intervención o tratamiento diseñado para explorar el fenómeno de la interferencia de la red sería la estrategia de explicar los cambios en el paquete de compensación con el objetivo de influir en el comportamiento organizacional. La estrategia puede verse como una versión de una red de campaña de persuación.

```{r, fig.align='center'}
# Darle forma de triángulo a los vértices
mytriangle <- function(coords, v = NULL, params) {
  vertex.color <- params("vertex", "color")
  if (length(vertex.color) != 1 && !is.null(v)) {
    vertex.color <- vertex.color[v]
  }
  vertex.size <- 1/200 * params("vertex", "size")
  if (length(vertex.size) != 1 && !is.null(v)) {
  vertex.size <- vertex.size[v]
  }

  symbols(x = coords[,1], y = coords[,2], bg = vertex.color,
  stars = cbind(vertex.size, vertex.size, vertex.size),
  add = TRUE, inches = FALSE)
}

add_shape("triangle", clip = shapes("circle")$clip, plot = mytriangle)
```

```{r, fig.align='center'}
# Indicar "race" a través de la forma del vértice
V(strike)[V(strike)$race=="YS"]$shape <- "circle"   # Empleado joven de habla hispana
V(strike)[V(strike)$race=="YE"]$shape <- "square"   # Empleado joven de habla inglesa
V(strike)[V(strike)$race=="OE"]$shape <- "triangle" # Empleado mayor de habla inglesa
```

```{r, fig.align='center'}
# Distingur los 4 representantes que difundieron la estrategia mediante colores
nv <- vcount(strike)
z <- numeric(nv)
z[c(21,22)] <- 1
z[c(5,15)] <- 2
V(strike)$color <- rep("white", nv)
V(strike)[z==1]$color <- "red3"
V(strike)[z==2]$color <- "green3"
```

```{r, fig.align='center'}
# Empleados sindicales (primera socialización de la estrategia)
V(strike)[z==1]$names
```

```{r, fig.align='center'}
# Empleados escogidos a partir del análisis de red (segunda socialización de la estrategia)
V(strike)[z==2]$names
```

```{r, fig.height = 8, fig.width = 8, fig.align = 'center'}
# Visualización
set.seed(42)
my.dist <- c(rep(1.8, 4), rep(2.2, 9), rep(2, 11))
l <- layout_with_kk(strike)
plot(strike,layout = l, vertex.label = V(strike)$names,
     vertex.label.degree = -pi/3,
     vertex.label.dist = my.dist)
```

Mientras que los dos representantes sindicales (Sam y Wendle) originalmente encargados de explicar los cambios en el paquete de compensación a los demás parecen alejados del resto de trabajadores, los dos empleados que luego fueron invitados a unirse (Bob y Norm) parecen ser mucho más centrales en la red. Esta impresión visual puede confirmarse examinando sus centralidades de intermediación (*betweenness*) y cercanía (*closeness*).

```{r, fig.align='center'}
print("betweenness")
print(V(strike)[z %in% c(1,2)]$names)
print(rank(-betweenness(strike))[z %in% c(1,2)])
```

```{r, fig.align='center'}
print("closeness")
print(V(strike)[z %in% c(1,2)]$names)
print(rank(-closeness(strike))[z %in% c(1,2)])
```

Aunque Bob y Norm ocupan el primer y segundo lugar según cualquier medida, Sam se encuentra un poco detrás de ellos, y Wendle está casi en el último lugar entre los 24 empleados de la red. Esta discrepancia tiene implicaciones directas no solo en la medida en que se difunden los mensajes deseados en la red, sino también en nuestra capacidad para estimar esta difusión.

# Inferencia causal bajo interferencia de red
